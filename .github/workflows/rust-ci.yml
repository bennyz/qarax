name: Rust CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened, labeled]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: qarax
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
          targets: x86_64-unknown-linux-musl
      - uses: Swatinem/rust-cache@v2
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools protobuf-compiler
      - name: Prepare sqlx
        run: |
          cargo install sqlx-cli --no-default-features --features postgres
          sqlx mig run
          cargo sqlx prepare --workspace
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/qarax
      - run: cargo clippy --workspace -- -D warnings
        env:
          SQLX_OFFLINE: true

  build:
    name: Build
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: qarax
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl
      - uses: Swatinem/rust-cache@v2
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools protobuf-compiler
      - name: Prepare sqlx
        run: |
          cargo install sqlx-cli --no-default-features --features postgres
          sqlx mig run
          cargo sqlx prepare --workspace
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/qarax
      - name: Build
        run: cargo build --workspace --release
        env:
          SQLX_OFFLINE: true
      - name: Upload binaries
        uses: actions/upload-artifact@v6
        with:
          name: binaries
          path: |
            target/x86_64-unknown-linux-musl/release/qarax
            target/x86_64-unknown-linux-musl/release/qarax-node
          retention-days: 1

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: qarax
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl
      - uses: Swatinem/rust-cache@v2
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools protobuf-compiler
      - name: Prepare sqlx
        run: |
          cargo install sqlx-cli --no-default-features --features postgres
          sqlx mig run
          cargo sqlx prepare --workspace
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/qarax
      - name: Run tests
        run: cargo test --workspace
        env:
          SQLX_OFFLINE: true
          DATABASE_URL: postgres://postgres:password@localhost:5432/qarax
          TEST_DATABASE_URL: postgres://postgres:password@localhost:5432/qarax
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USERNAME: postgres
          DATABASE_PASSWORD: password
          DATABASE_NAME: qarax

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    # Run on push to master, or on PRs with 'run-e2e' label
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'run-e2e')
    steps:
      - uses: actions/checkout@v6

      - name: Download binaries
        uses: actions/download-artifact@v7
        with:
          name: binaries
          path: target/x86_64-unknown-linux-musl/release/

      - name: Make binaries executable
        run: chmod +x target/x86_64-unknown-linux-musl/release/*

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Check KVM availability
        run: |
          if [ -e /dev/kvm ]; then
            echo "KVM is available"
            ls -la /dev/kvm
          else
            echo "KVM is NOT available - E2E tests will be skipped"
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run E2E tests
        working-directory: e2e
        run: |
          # Build and start services
          docker compose up -d --build

          # Wait for services to be healthy
          echo "Waiting for services..."
          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            healthy_count=$(docker compose ps 2>/dev/null | grep -c "(healthy)" || echo "0")
            if [ "$healthy_count" -ge "3" ]; then
              echo "All services are healthy!"
              break
            fi
            if docker compose ps 2>/dev/null | grep -q "Exit"; then
              echo "A service has failed!"
              docker compose ps
              docker compose logs
              exit 1
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done

          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for services"
            docker compose ps
            docker compose logs
            exit 1
          fi

          bash setup_host.sh

          # Install Python dependencies and run tests
          uv sync --frozen
          uv run pytest test_vm_lifecycle.py -v

      - name: Show logs on failure
        if: failure()
        working-directory: e2e
        run: |
          echo "=== Docker Compose Status ==="
          docker compose ps
          echo ""
          echo "=== qarax logs ==="
          docker compose logs qarax --tail=100
          echo ""
          echo "=== qarax-node logs ==="
          docker compose logs qarax-node --tail=100
          echo ""
          echo "=== postgres logs ==="
          docker compose logs postgres --tail=50

      - name: Cleanup
        if: always()
        working-directory: e2e
        run: docker compose down -v
