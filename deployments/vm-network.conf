# sysctl configuration for qarax VMM host networking
# This file configures kernel parameters needed for VM networking

# Enable IP forwarding for IPv4 and IPv6
# Required for VMs to communicate through the host
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1

# Bridge networking configuration
# Disable netfilter on bridges to improve performance
net.bridge.bridge-nf-call-iptables = 0
net.bridge.bridge-nf-call-ip6tables = 0
net.bridge.bridge-nf-call-arptables = 0

# Disable filtering on bridge by default
net.bridge.bridge-nf-filter-vlan-tagged = 0

# TCP/IP stack tuning for VM workloads
# Increase connection tracking table size
net.netfilter.nf_conntrack_max = 262144
net.nf_conntrack_max = 262144

# TCP performance tuning
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 60
net.ipv4.tcp_keepalive_probes = 3

# Allow more local ports for outbound connections
net.ipv4.ip_local_port_range = 10000 65535

# Increase socket buffer sizes for better throughput
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.core.rmem_default = 16777216
net.core.wmem_default = 16777216
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# Increase backlog for better connection handling
net.core.netdev_max_backlog = 5000
net.core.somaxconn = 4096

# ARP cache settings for environments with many VMs
net.ipv4.neigh.default.gc_thresh1 = 1024
net.ipv4.neigh.default.gc_thresh2 = 4096
net.ipv4.neigh.default.gc_thresh3 = 8192

# Security: Prevent IP spoofing
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1

# Disable ICMP redirect acceptance and sending
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Disable source packet routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Increase max number of memory map areas for VMs
vm.max_map_count = 262144
